<%= layout('/layouts/boilerplate') %>

<style>
  .card-img-top {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
  }
  
  .hero-section {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    padding: 3rem 0;
    margin-bottom: 2rem;
    border-radius: 0.5rem;
  }
  
  .badge {
    font-size: 0.8rem;
    font-weight: 500;
    padding: 0.5rem 0.75rem;
  }
  
  .subscription-card {
    transition: transform 0.3s ease;
    border-radius: 12px;
    background-color: #2c3034;
    border-color: #373b3e;
  }
  
  .subscription-card:hover {
    transform: translateY(-5px);
  }
  
  .card-price {
    font-size: 1.25rem;
    color: #818cf8;
  }
  
  .filter-btn {
    background-color: #4f46e5;
    color: white;
    border: none;
  }
  
  .filter-btn:hover {
    background-color: #4338ca;
    color: white;
  }
  
  .search-btn {
    background-color: #4f46e5;
    color: white;
    border: none;
  }
  
  .search-btn:hover {
    background-color: #4338ca;
    color: white;
  }
  
  .join-btn {
    background-color: #2c3034;
    transition: all 0.2s ease;
    border: 2px solid #4f46e5;
    color: #818cf8;
  }
  
  .join-btn:hover {
    background-color: #4f46e5;
    color: white;
  }
  
  .category-badge {
    border-radius: 50px;
    padding: 0.35rem 0.75rem;
  }
  
  .slots-badge {
    border-radius: 50px;
    padding: 0.35rem 0.75rem;
    background-color: #495057;
  }
  
  .offcanvas-header {
    background-color: #4f46e5;
    color: white;
  }
  
  .offcanvas {
    background-color: #212529;
    color: #e9ecef;
  }
  
  .list-group-item {
    background-color: #2c3034;
    color: #e9ecef;
    border-color: #373b3e;
  }
  
  .list-group-item:hover {
    background-color: #343a40;
    color: #818cf8;
  }
  
  .text-muted {
    color: #adb5bd !important;
  }
  
  .card-footer {
    background-color: #2c3034 !important;
    border-top-color: #373b3e !important;
  }
  
  .btn-outline-primary, .btn-outline-success, .btn-outline-danger, 
  .btn-outline-info, .btn-outline-warning {
    color: #e9ecef;
  }
  
  .btn-outline-primary:hover, .btn-outline-success:hover, .btn-outline-danger:hover, 
  .btn-outline-info:hover, .btn-outline-warning:hover {
    color: #212529;
  }
</style>

<div class="container py-4">
  <!-- Hero Section -->
  <div class="hero-section text-center mb-4 shadow">
    <h1 class="display-5 fw-bold mb-3">Find Your Perfect Subscription Match</h1>
    <p class="lead mb-4">Join thousands of users saving money by sharing premium subscription plans</p>
    <div class="d-flex justify-content-center gap-3">
      <button
        class="btn filter-btn btn-lg"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#offcanvasExample"
        aria-controls="offcanvasExample"
      >
        <i class="bi bi-funnel-fill me-2"></i> Browse Categories
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold mb-0">Available Plans</h2>
        <button
          class="btn filter-btn"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#offcanvasExample"
          aria-controls="offcanvasExample"
        >
          <i class="bi bi-sliders me-2"></i> Filters
        </button>
      </div>
    </div>
  </div>

  <!-- Offcanvas Filter Menu -->
  <div
    class="offcanvas offcanvas-start"
    tabindex="-1"
    id="offcanvasExample"
    aria-labelledby="offcanvasExampleLabel"
  >
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="offcanvasExampleLabel">
        Find Subscriptions
      </h5>
      <button
        type="button"
        class="btn-close btn-close-white"
        data-bs-dismiss="offcanvas"
        aria-label="Close"
      ></button>
    </div>
    <div class="offcanvas-body">
      <div>
        <form class="d-flex" role="search" action="/search" method="get">
          <input
            class="form-control me-2"
            type="search"
            placeholder="Search for plans..."
            aria-label="Search"
            name="query"
          />
          <button class="btn search-btn" type="submit">
            Search
          </button>
        </form>
      </div>

      <div class="mt-4">
        <h5 class="fw-bold mb-3">Popular Subscriptions</h5>
        <div class="list-group rounded-3">
          <a
            href="/search?query=Netflix"
            class="list-group-item list-group-item-action d-flex align-items-center"
          >
            <i class="bi bi-film text-danger me-2"></i> Netflix
          </a>
          <a
            href="/search?query=Amazon Prime"
            class="list-group-item list-group-item-action d-flex align-items-center"
          >
            <i class="bi bi-amazon text-warning me-2"></i> Amazon Prime
          </a>
          <a
            href="/search?query=Disney+"
            class="list-group-item list-group-item-action d-flex align-items-center"
          >
            <i class="bi bi-display text-primary me-2"></i> Disney+
          </a>
          <a
            href="/search?query=Hulu"
            class="list-group-item list-group-item-action d-flex align-items-center"
          >
            <i class="bi bi-tv text-success me-2"></i> Hulu
          </a>
          <a
            href="/search?query=Spotify"
            class="list-group-item list-group-item-action d-flex align-items-center"
          >
            <i class="bi bi-spotify text-success me-2"></i> Spotify
          </a>
          <a
            href="/search?query=YouTube Premium"
            class="list-group-item list-group-item-action d-flex align-items-center"
          >
            <i class="bi bi-youtube text-danger me-2"></i> YouTube Premium
          </a>
          <a
            href="/search?query=Apple Music"
            class="list-group-item list-group-item-action d-flex align-items-center"
          >
            <i class="bi bi-music-note-beamed text-danger me-2"></i> Apple Music
          </a>
        </div>
      </div>

      <div class="mt-4">
        <h5 class="fw-bold mb-3">Categories</h5>
        <div class="d-flex flex-wrap gap-2">
          <a href="/search?category=Streaming" class="btn btn-outline-primary btn-sm">Streaming</a>
          <a href="/search?category=Music" class="btn btn-outline-success btn-sm">Music</a>
          <a href="/search?category=Gaming" class="btn btn-outline-danger btn-sm">Gaming</a>
          <a href="/search?category=Productivity" class="btn btn-outline-info btn-sm">Productivity</a>
          <a href="/search?category=Education" class="btn btn-outline-warning btn-sm">Education</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Plan Cards -->
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    <% for(let plan of plans){%>
    <div class="col">
      <div class="card h-100 shadow subscription-card border-0">
        <!-- Subscription Image -->
        <img
          src="<%= plan.image %>"
          class="card-img-top"
          alt="Subscription Image"
        />

        <!-- Card Body -->
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="card-title fw-bold mb-0"><%= plan.name %></h4>
            <span class="badge category-badge bg-primary"><%= plan.type %></span>
          </div>
          
          <p class="text-muted"><%= plan.description %></p>

          <!-- Subscription Details -->
          <div class="d-flex justify-content-between align-items-center my-3">
            <h5 class="card-price fw-bold mb-0">
              â‚¹<%= plan.price %> <small class="text-muted">/ month</small>
            </h5>
            <span class="badge slots-badge">
              <i class="bi bi-people-fill me-1"></i> <%= plan.slots %> Slots Left
            </span>
          </div>

          <% if(!currUser){ %>
          <a href="/join/<%= plan._id %>" class="text-decoration-none">
            <button class="btn join-btn w-100">
              <i class="bi bi-person-plus-fill me-2"></i> Join Now
            </button>
          </a>
          <% }else if(plan.owner._id.toString() === currUser._id.toString()){ %>
          <!-- <div class="mb-2">
            <span class="badge bg-info text-dark">
              <i class="bi bi-star-fill me-1"></i> You own this plan
            </span>
          </div> -->
          <div class="row g-2">
            <div class="col">
              <a href="/mysub/<%= plan._id %>" class="btn btn-outline-primary w-100">
                <i class="bi bi-pencil-square me-1"></i> Edit
              </a>
            </div>
            <div class="col">
              <form
                action="/mysub/<%= plan._id %>?_method=DELETE"
                method="POST"
              >
                <button type="submit" class="btn btn-outline-danger w-100">
                  <i class="bi bi-trash me-1"></i> Delete
                </button>
              </form>
            </div>
          </div>
          <% }else{ %>
          <div class="mb-2">
            <span class="text-muted">
              <i class="bi bi-person-circle me-1"></i> Owner: <strong><%= plan.owner.username %></strong>
            </span>
          </div>
          <button
            class="btn join-btn w-100"
            data-id="<%= plan._id %>"
            data-price="<%= plan.price %>"
            data-name="<%= plan.name %>"
          >
            <i class="bi bi-credit-card-fill me-2"></i> Join Plan
          </button>
          <% } %>
        </div>

        <div class="card-footer">
          <small class="text-muted">
            <i class="bi bi-calendar-event me-1"></i> Expires on:
            <strong
              ><%= new Date(plan.expDate).toLocaleDateString("en-IN", {day:
              'numeric', month: 'long', year: 'numeric'}) %></strong
            >
          </small>
        </div>
      </div>
    </div>
    <% } %>
  </div>
  
  <!-- Empty State (if no plans) -->
  <% if(plans.length === 0){ %>
  <div class="text-center py-5">
    <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
    <h3 class="mt-3">No plans found</h3>
    <p class="text-muted">Try adjusting your search filters or create a plan yourself!</p>
    <a href="/create" class="btn btn-primary mt-2">Create a New Plan</a>
  </div>
  <% } %>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<% if(currUser){ %>
<script>
  document.querySelectorAll(".join-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const planId = btn.dataset.id;
      const price = parseFloat(btn.dataset.price);
      const planName = btn.dataset.name;

      if (isNaN(price)) {
        alert("Invalid price");
        return;
      }

      // Create Razorpay order
      const res = await fetch("/create-order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount: price }),
      });

      const data = await res.json();
      if (!data.success) {
        alert("Failed to create order");
        return;
      }

      const options = {
        key: "<%= razorpayKeyId %>",
        amount: data.order.amount,
        currency: "INR",
        name: "SubSplit",
        description: `Joining ${planName}`,
        order_id: data.order.id,
        handler: function (response) {
          // On successful payment, redirect to /join/:id
          window.location.href = `/join/${planId}`;
        },
        prefill: {
          name: "<%= currUser.username %>",
          email: "<%= currUser.email %>",
        },
        theme: {
          color: "#4f46e5",
        },
      };

      const rzp = new Razorpay(options);
      rzp.open();
    });
  });
</script>
<% } %>